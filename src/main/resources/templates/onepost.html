<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
    <link rel="icon" href="https://i.postimg.cc/YqTT15xb/image.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&nd 개발자들의 공모전 커뮤니티</title>

    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/main.css"/>
    <!--    <link rel="stylesheet" href="/static/css/main.css"/>-->

    <!-- font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"
            integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>

    <!-- summernote -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

    <!-- js Cookie -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

    <!-- swiper -->
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

    <!-- SockJS -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

    <!-- Stomp -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>
<header>
    <div class="logo">
        <img src="https://i.postimg.cc/T3KxY0gd/2.png" alt="Logo">
    </div>

    <div class="search-bar">
        <input type="text" placeholder="공모전 검색">
        <div class="search-icon">
            <img src="https://i.postimg.cc/MT8tf3Qy/searchmagnifierinterfacesymbol-79894.png" alt="Search Icon">

        </div>
    </div>
    <div class="auth-buttons">
        <button onclick="redirectToLogin()">Login / Signup</button>
    </div>
</header>
<div class="container">
    <nav class="main-category-bar">
        <a href="#">공모전</a>
        <a href="#">공지사항</a>
        <a href="#">이벤트</a>
        <a href="#">자유게시판</a>
    </nav>
</div>
<body>
<div class="main-container">
    <p id="postIdParagraph" style="display: none;">postId: <span th:text="${postId}"></span></p>
    <div class="card mb-3" style="max-width: 50rem;">
        <div class="card-header">
            <button id="updatePost">수정</button>
            <button id="deletePost">삭제</button>
            <button id="reportPost">신고</button>
        </div>
        <div class="card-body">
            <h5 class="card-title" id="postTitle"></h5>
            <p class="card-text" id="postWriter"></p>
            <p class="card-text" id="postDate"></p>
            <p class="card-text" id="postCount"></p>
            <p class="card-text" id="postContent"></p>
        </div>
    </div>

    <!-- Display comments -->
    <div class="card mb-3" style="max-width: 50rem;">
        <div class="card-body">
            <h5 class="card-title">댓글</h5>
        </div>
        <form id="comment-form">
            <input type="hidden" id="postId" th:value="${postId}"> <!-- Replace "your_post_id_here" with the actual post ID -->
            <textarea id="comment-content" placeholder="댓글을 입력해주세요."></textarea>
            <button type="submit">댓글 쓰기</button>
        </form>
        <div id="commentContainer">
            <p class="card-text" id="commentWriter"></p>
            <p class="card-text" id="commentDate"></p>
            <p class="card-text" id="commentContent"></p>
            <button class="delete-comment-btn" data-comment-id="${comment.commentId}">댓글 삭제</button>
            <button class="report-comment-btn" data-comment-id="${comment.commentId}">댓글 신고</button>
        </div>
    </div>
    </div>
</body>
</html>
<style>
    body {
        font-family: Arial, sans-serif;
    }

    .main-container {
        margin-left: auto;
        margin-right: auto;
        max-width: 50rem; /* Adjust the maximum width as needed */
    }

    h1 {
        font-size: 24px;
    }

    h2 {
        font-size: 20px;
    }

    #comments-container {
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 20px;
    }

    .comment {
        border: 1px solid #ddd;
        padding: 10px;
        margin: 10px 0;
        background-color: #f9f9f9;
    }

    #comment-content {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
    }

    button[type="submit"] {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
    }

    /* Reset some default styles */
    body, h1, h2, p, ul, li {
        margin: 0;
        padding: 0;
    }

    body {
        font-family: Arial, sans-serif;
    }

    /* Header Styles */
    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background-color: linen;
    }

    .logo img {
        max-width: 150px;
        height: auto;
    }

    .search-bar {
        display: flex;
        align-items: center;
    }

    .search-bar input[type="text"] {
        padding: 10px;
        border: 2px solid lightgray;
        border-radius: 20px;
        width: 300px; /* Adjust the width as needed */
    }

    .search-icon {
        margin-left: -40px;
        padding: 8px;
        background-color: white;
        border-radius: 50%;
        cursor: pointer;
        width: 17px;
        height: 17px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .search-icon img {
        max-width: 90%;
        max-height: 90%;
    }


    .auth-buttons button {
        margin-left: 10px;
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        background-color: lightsalmon;
        color: white;
        cursor: pointer;
    }

    .container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background-color: #fff;
    }

    .swiper-container {
        margin-top: 30px;
        width: 100%; /* Adjust the width as needed */
        height: 400px; /* Adjust the height as needed */
        margin: 0 auto;
        margin-bottom: 20px;

    }

    .swiper-slide img {
        width: 100%; /* Change the width to 100% */
        height: 100%;
        max-width: none; /* Remove max-width */
        margin: 0 auto;
        object-fit: cover;
        margin-bottom: 20px;
    }

    .main-category-bar {
        display: flex;
        align-items: center;
    }

    .main-category-bar a {
        margin: 0 30px;
        text-decoration: none;
        color: black;
        font-weight: bold;
        font-size: 20px;
        transition: color 0.3s ease;
    }

    .main-category-bar a:hover {
        color: lightsalmon;
    }
</style>
<script>
    // 게시글
    function removeTags(input) {
        // Use a regular expression to remove <p> and <br> tags
        return input.replace(/<p>|<\/p>|<br>/g, '');
    }

    $(document).ready(function () {
        // Extract the postId from the HTML
        var postId = $('#postIdParagraph span').text();

        // Fetch post information from your API endpoint
        $.ajax({
            type: 'GET',
            url: `/api/posts/${postId}`,
        })
            .done(function (response) {
                // Sanitize the content by removing <p> and <br> tags
                var sanitizedContent = removeTags(response.contents);

                // Update the HTML elements with the sanitized content
                $('#postTitle').text(response.title);
                $('#postWriter').text('작성자: ' + response.writer);
                $('#postDate').text('작성일: ' + response.modifiedDate);
                $('#postCount').text('조회수: ' + response.communityPostViews); // Correct variable name
                $('#postContent').html(sanitizedContent); // Use .html() to render HTML tags
            })
            .fail(function (response) {
                console.error('게시글을 불러올 수 없습니다.', response);
            });
    });

    $(document).ready(function () {
        // Extract the postId from the HTML
        var postId = $('#postIdParagraph span').text();

        $('#deletePost').click(function () {
            // Show a confirmation dialog and handle post deletion
            if (confirm('게시글을 삭제하시겠습니까?')) {
                $.ajax({
                    type: 'DELETE',
                    url: `/api/posts/${postId}`,
                })
                    .done(function () {
                        window.location.href = '/view/main'; // Change the URL to your homepage URL
                    })
                    .fail(function (error) {
                        console.error('Failed to delete post.', error);
                    });
            }
        });
    });

    $(document).ready(function () {
        // Extract the postId from the HTML
        var postId = $('#postIdParagraph span').text();

        $('#reportPost').click(function () {
            // Use the prompt dialog to get the report reason from the user
            var reportReason = prompt('게시글을 신고하려는 이유를 입력해주세요:');

            // Validate if the report reason is not empty
            if (!reportReason) {
                alert('신고 이유를 입력해주세요.'); // Provide feedback to the user
                return;
            }

            // Create a report object with the reason
            var reportData = {
                reportReason: reportReason
            };

            $.ajax({
                type: 'POST',
                url: `/api/posts/${postId}/report`, // Adjust the URL to match your API endpoint
                contentType: 'application/json',
                data: JSON.stringify(reportData),
            })
                .done(function (response) {
                    console.log('Server response:', response); // Log the server response for debugging

                    if (response.status === 200) {
                        alert('게시글 신고가 완료되었습니다.');
                    } else if (response.status === 400) {
                        alert('이미 신고한 게시글입니다.'); // Display an error message if the user has already reported the post
                    }

                    // Redirect to the main homepage after successful reporting
                    window.location.href = `/view/onepost/${postId}`; // Change the URL to your homepage URL
                })
                .fail(function (error) {
                    console.error('게시물 신고에 실패했습니다.', error);
                });
        });
    });

    // 코멘트
    $(document).ready(function () {
        var postId = $('#postId').val();

        function createCommentCard(comment) {
            var commentCard = $('<div class="card mb-3"></div>');

            // Build the content for the comment card
            var cardContent = `
                <div class="card-body">
                    <p class="card-text comment-writer">작성자: ${comment.writer}</p>
                    <p class="card-text comment-date">작성일: ${comment.modifiedDate}</p>
                    <p class="card-text comment-content">${comment.content}</p>
                    <button type="button" class="btn btn-danger delete-comment-btn" data-comment-id="${comment.commentId}">댓글 삭제</button>
                    <button type="button" class="btn btn-warning report-comment-btn" data-comment-id="${comment.commentId}">댓글 신고</button>
                </div>

                `;

            commentCard.html(cardContent);

            $('#commentContainer').append(commentCard);
        }

        // 댓글 로드
        function loadComments() {
            $.ajax({
                type: 'GET',
                url: `/api/comments/${postId}`,
            })
                .done(function (comments) {
                    $('#commentContainer').empty();

                    comments.forEach(function (comment) {
                        createCommentCard(comment);
                    });
                })
                .fail(function (error) {
                    console.error('Failed to fetch comments:', error);
                });
        }

        loadComments();

        $('#comment-form').submit(function (event) {
            event.preventDefault();

            var commentContent = $('#comment-content').val();
            if (!commentContent) {
                alert('Please enter a comment.');
                return;
            }

            $.ajax({
                type: 'POST',
                url: `/api/comments/${postId}`,
                contentType: 'application/json',
                data: JSON.stringify({content: commentContent}),
            })
                .done(function (response) {
                    console.log('Comment added:', response);
                    $('#comment-content').val('');
                    loadComments();
                    window.location.href = `/view/onepost/${postId}`;
                })
                .fail(function (error) {
                    console.error('Failed to add comment:', error);
                });
        });

        $(document).off('click', '.delete-comment-btn').on('click', '.delete-comment-btn', function () {
            console.log('Delete button clicked.');
            var commentId = $(this).data('comment-id');
            console.log('Clicked Delete Button. Comment ID:', commentId);

            if (confirm('댓글을 삭제하시겠습니까?')) {
                deleteComment(commentId);
            }
        });

        function deleteComment(commentId) {
            $.ajax({
                type: "DELETE",
                url: `/api/comments/${commentId}`,
                dataType: "json"
            }).done(function (res) {
                if (res.status === 200) {
                    alert("댓글을 성공적으로 삭제했습니다.");
                } else {
                    alert(res.message);
                }

                loadComments(); // Refresh the comments after deletion
            }).fail(function (request, status, error) {
                console.error("댓글 삭제가 완료되지 않았습니다.", error);
            });
        }
    });

    function reportComment(commentId) {
        var reportReason = prompt('댓글을 신고하려는 이유를 입력해주세요:');

        // Validate if the report reason is not empty
        if (!reportReason) {
            alert('신고 이유를 입력해주세요.'); // Provide feedback to the user
            return;
        }

        // Create a report object with the reason
        var reportData = {
            reportReason: reportReason
        };

        $.ajax({
            type: 'POST',
            url: `/api/comments/${commentId}/report`, // Adjust the URL to match your API endpoint
            contentType: 'application/json',
            data: JSON.stringify(reportData),
        })
            .done(function (response) {
                console.log('Server response:', response);

                if (response.status === 200) {
                    alert('댓글 신고가 완료되었습니다.');
                } else if (response.status === 400) {
                    alert('이미 신고한 댓글입니다.');
                }

            })
            .fail(function (error) {
                console.error('댓글 신고에 실패했습니다.', error);
            });
    }

    $(document).off('click', '.report-comment-btn').on('click', '.report-comment-btn', function () {
        var commentId = $(this).data('comment-id');
        reportComment(commentId);
    });


</script>